<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, minimum-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no,email=no" />
    <title>问题描述</title>
    <link rel="stylesheet" type="text/css" href="css/base.min.css" />    
    <link rel="stylesheet" type="text/css" href="css/common.css" />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/rem.js"></script>
<style>
    html{font-size: 100px;background: #eaeaea;}
    body{font-size: .18rem;}
    .w{padding:0 .37rem;}
    #next{margin-top:.34rem;margin-bottom: 0.8rem;}
    #defect-describe{
        width: 80%;
        font-size: .25rem;
        margin-left: .72rem;
        margin-top: .25rem;    
        height:80%; 
    }
    .icon-bi{position: absolute;top:0rem;}
</style>
</head>
<body>
    <div class="wrap">
        <div class="form">
            <form id="oForm" action="javascript:;">
                <div id="person-info">
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-qichecar26"></i>
                            <input class="mustInput" id="general-category" type="text" placeholder="总成分类(必选)"readonly="readonly"/>
                            <div class="input-remind">
								<span>此项不能为空</span>
							</div>
                            <i class="iconfont icon-xia"></i>                            
                        </div>
                         <!-- 弹出 -->
                        <div class="check-modal modal">
                             <div class="modal-content">
                                 <div class="modal-head w">
                                     <h2 class="text-center">选择分类</h2>
                                 </div>
                                 <div class="modal-body w">
                                     <ul class="modal-option">
                                         <li data-value="fenlei1">分类1</li>
                                         <li data-value="fenlei2">分类2</li>
                                         <li data-value="fenlei3">分类3</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei5">分类5</li>  
                                         <li data-value="fenlei3">分类3</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei5">分类5</li>
                                         <li data-value="fenlei3">分类3</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei5">分类5</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei5">分类5</li>  
                                         <li data-value="fenlei3">分类3</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei5">分类5</li>
                                         <li data-value="fenlei3">分类3</li>
                                         <li data-value="fenlei4">分类4</li>
                                         <li data-value="fenlei123">123</li>                                       
                                     </ul>
                                 </div>
                                 <div class="modal-footer"></div>
                             </div>   
                        </div>
                         <!-- 弹出 -->
                    </div>
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-dingwei"></i>
                            <input class="" type="text" placeholder="您反馈问题的具体部位(可填)"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-item w describe">
                            <i class="iconfont icon-bi"></i>
                            <textarea class="mustInput" name="" id="defect-describe"  rows="4" placeholder="问题具体描述(必填)"></textarea>
                            <div class="input-remind">
								<span>此项不能为空</span>
							</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-item w photo">
                            <i class="iconfont icon-zhaoxiangji"></i>
                            <div class="photo-list">
                                <input class="" type="text" placeholder="上传问题照片(可选)" readonly="readonly"style="line-height: 3;"/>                  
                            </div>
                            <div class="file-list">
                                <input id="file-defect-photo0" name="fileToUpload" type="file" class="hide fileToUpload"/>
                            </div>
                            <label id="upLodaBtn" for="file-defect-photo0" class="iconfont icon-iconfontjia"></label>
                        </div>
                        <div class="form-explain">
                            <p>最多可上传5张照片</p>
                        </div>
                        <!-- 编辑图片 -->
                        <div class="swipeUp-modal modal">
                            <div class="modal-content">
                                 <div class="modal-body w">
                                     <ul>
                                         <li id="show-img">查看大图</li>
                                         <li id="delel-img"><span class="color-red">删除照片</span></li>
                                     </ul>
                                 </div>
                                 <div id="close-modal" class="modal-footer">
                                     <span>取消</span>
                                 </div>
                             </div>   
                        </div>
                        <!-- 编辑图片结束 -->
                        <!-- 图片查看 -->
                        <div class="showImg-modal modal">
                            <div class="modal-content" style="display: none">
                                 
                            </div> 
                            <div class="show-box flex-container">
                                <div class="f1 text-center">
                                    
                                </div>
                            </div>
                        </div>
                        <!-- 图片查看结束 -->
                    </div>
                </div>
                <div id="person-address">
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-weibiaoti8"></i>
                            <input type="text" placeholder="如果更换过零件 请填写更换零件名称(可填)"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-icon7"></i>
                            <input class="mustInput" id="accident" type="text" placeholder="是否发生交通事故(必选)" readonly="readonly"/>
                            
                            <i class="iconfont icon-xia"></i>
                            <div class="input-remind">
                                <span>此项不能为空</span>
                            </div>
                        </div>
                        <!-- 弹出开始 -->
                        <div class="radio-modal modal">
                             <div class="modal-content">
                                 <div class="modal-head w">
                                     <h2 class="text-center">请选择</h2>
                                 </div>
                                 <div class="modal-body w">
                                     <div class="radio-box flex-container">
                                         <div class="f1">                                                  
                                            <input id="yes" type="radio" name="whether" value="yes">
                                            <label for="yes" class="text-center" date-value="发生过交通事故">
                                                <i class=" iconfont icon-gou"></i> 
                                            是</label>
                                         </div>
                                         <div class="f1">
                                            <input id="no" type="radio" name="whether" value="no">
                                            <label for="no" class="text-center" date-value="未发生过交通事故">
                                                <i class="iconfont icon-x"></i> 
                                            否</label>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="modal-footer"></div>
                             </div>                            
                        </div>
                    <!-- 弹出结束-->
                    </div>
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-shoushang"></i>
                            <input class="mustInput" id="hurt" type="text" placeholder="是否造成人员伤亡(必选)" readonly="readonly"/>
                            
                            <i class="iconfont icon-xia"></i>
                            <div class="input-remind">
                                <span>此项不能为空</span>
                            </div>
                        </div>
                        <!-- 弹出开始 -->
                        <div class="radio-modal modal">
                             <div class="modal-content">
                                 <div class="modal-head w">
                                     <h2 class="text-center">请选择</h2>
                                 </div>
                                 <div class="modal-body w">
                                     <div class="radio-box flex-container">
                                         <div class="f1">                                                  
                                            <input id="yes" type="radio" name="whether" value="yes">
                                            <label for="yes" class="text-center" date-value="造成人员伤亡">
                                                <i class="iconfont icon-gou"></i> 
                                            是</label>
                                         </div>
                                         <div class="f1">
                                            <input id="no" type="radio" name="whether" value="no">
                                            <label for="no" class="text-center" date-value="未造成人员伤亡">
                                                <i class="iconfont icon-x"></i> 
                                            否</label>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="modal-footer"></div>
                             </div>   
                         <!-- 弹出结束-->
                    </div>
                    </div>
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-anquan"></i>
                            <input class="mustInput" id="warranty" type="text" placeholder="是否保修期内(必选)" readonly="readonly"/>
                            
                            <i class="iconfont icon-xia"></i>
                            <div class="input-remind">
                                <span>此项不能为空</span>
                            </div>
                        </div>
                        <!-- 弹出 -->
                        <div class="warranty-modal modal">
                             <div class="modal-content">
                                 <div class="modal-head w">
                                     <h2 class="text-center">请选择</h2>
                                 </div>
                                 <div class="modal-body w">
                                     <div class="radio-box flex-container">
                                         <div class="f1">                                                  
                                            <input id="yes" type="radio" name="whether" value="yes">
                                            <label for="yes" class="text-center" date-value="在保">
                                                <i class="iconfont icon-gou"></i> 
                                            在保</label>
                                         </div>
                                         <div class="f1">
                                            <input id="no" type="radio" name="whether" value="no">
                                            <label for="no" class="text-center" date-value="出保">
                                                <i class="iconfont icon-x"></i> 
                                            出保</label>
                                         </div>
                                     </div>
                                 </div>
                                 <div class="modal-footer"></div>
                             </div>   
                        </div>
                     <!-- 弹出 -->
                    </div>
                    <div class="row-space"></div>
                    <div class="form-group">
                        <div class="form-item w">
                            <i class="iconfont icon-zhiweimiaoshu"></i>
                            <input type="text" placeholder="其他说明(可填)"/>
                        </div>
                        <div class="form-explain">
                            <p>如是否在其他渠道反馈过</p>
                        </div>
                    </div>
                    
                </div>
                <div id="next" class="text-center">
                    <input type="submit" class="btn btn-next" value="下一步" />                   
                    <a href="javascript:;" class="btn btn-prev">上一步</a>
                </div>
            </form>
        </div>
    </div>
    <script src="js/index.js"></script>
    <script src="plugins/upLoad/js/lrz.bundle.js"></script>  
    <script>
        !function($){
            "use strict";
            var oCheckModal=document.querySelector(".check-modal"),
                defectPhoto=document.getElementById('file-defect-photo0'),
                $aLi=$(".modal-option li"),
                oUl=document.querySelector("#person-info .modal-option"),
                $generalCategory=$("#general-category"),              
                dropDown=document.querySelectorAll(".icon-xia"),
                oForm=document.getElementById("oForm");

            /*分类弹出框*/    
            var checkClass=new modal(oCheckModal),
                slide=new slideModal(oCheckModal);
            dropDown[0].addEventListener("touchstart",function(){
                slide.show();
                return false;
            },false);

            var start =0,stop=0,flag2=1;
            oUl.addEventListener("touchstart",fnStar);
            oUl.addEventListener("touchmove",fnMove);
            oUl.addEventListener("touchend",fnEnd);
            function fnStar(ev){
                start = Date.now();
                flag2=1;                      
            }
            function fnMove(){
                flag2=0;
            }
            function fnEnd(ev){
                stop = Date.now();
                var oSrc=ev.srcElement||ev.target;
                if(oSrc.tagName=="LI" && flag2){
                    oCheckModal.style.display="none";
                    $generalCategory.val(oSrc.innerHTML);
                    //分类的data-value
                    console.log($(oSrc).attr("data-value"));
                }
            }
            /*缺陷图片上传*/
            var $oPhoto=$("#person-info .photo"),
                $fileList=$("#person-info .file-list"),
                $upLodaBtn=$("#upLodaBtn"),
                $photoList=$oPhoto.find(".photo-list");//缩略图列表
                /*new modal*/
            var swipeUpModal=document.querySelector("#person-info .swipeUp-modal"),
                showImgModal=document.querySelector("#person-info .showImg-modal");
            var swipeUp=new modal(swipeUpModal),
                showImg=new modal(showImgModal);

            var closeModal=document.querySelector("#close-modal"),
                delelImg=document.getElementById("delel-img"),
                showImgLi=document.getElementById("show-img");
            var imgIndex=0,inputArr=[0],imgId=0;
            
            /*取localStorage中的缩略图*/
            for(var i=0;i<5;i++){
            	if(localStorage.getItem("defectPhoto"+i)!=null){
            		var img = document.createElement("img");
            	    img.src = localStorage.getItem("defectPhoto"+i);
            	  	//返回被点击的图片的index 
            	    img.setAttribute("data-id",i);
            		$photoList.append(img);
            		$(img).on("touchstart",function(){
                        swipeUp.show();
                        imgIndex=$(this).index();
                        imgId=this.getAttribute("data-id");
                  	})
                }
            }              
            //取完缓存图片后检测图片长度
            if($photoList.children().length>5){   
                $upLodaBtn.hide();             
            }
            if($photoList.children().length>1){
                $photoList.children().eq(0).addClass("hide")
            }
            
            defectPhoto.addEventListener('change',fileFn);
            function fileFn(){
                    var $photoList=$oPhoto.find(".photo-list");

                    lrz(this.files[0])
                        .then(function (rst) {
                            // 处理成功会执行
                            var fileId=$fileList.children().length;
                            $fileList.each(function(index,item){

                            })
                            for(var i=0;i<inputArr.length;i++){
                                if(fileId==inputArr[i]){
                                    fileId++;
                                }
                            }
                            inputArr.push(fileId);
                            var img = document.createElement("img");
                            img.src=rst.base64;  
                            //添加预览图片和input-file                      
                            $photoList.append(img);
                            //限制图片长度                           
                            if($photoList.children().length>5){   
                                $upLodaBtn.hide();             
                                return false;
                            }
                            $fileList.append('<input id="file-defect-photo'+fileId+'" name="fileToUpload" type="file" class="hide fileToUpload">');
                            //改变id
                            $upLodaBtn.attr({"for":"file-defect-photo"+fileId});
                            defectPhoto=document.getElementById("file-defect-photo"+fileId);
                            //给新的input加事件
                            defectPhoto.addEventListener('change',fileFn);
                            
                            console.log(inputArr);
                            $(img).on("touchstart",function(){
                                swipeUp.show();
                                //返回被点击的图片的index
                                imgIndex=$(this).index();
                            })  
                            
                            if($photoList.children().length>=0){
                                $photoList.children().eq(0).addClass("hide");
                            }                      
                        })
                        .catch(function (err) {
                            // 处理失败会执行
                        })
                        .always(function () {
                            // 不管是成功失败，都会执行
                        });
            }
            //取消查看删除
            $(swipeUpModal).on("touchstart",function(ev){
                //ev.target==jq来源元素
                if(closeModal.contains(ev.target)){
                    swipeUpModal.style.display="none";
                }else if(delelImg.contains(ev.target)){
                    //移除图片
                    $photoList.children().eq(imgIndex).remove();
                    $fileList.children().eq(imgIndex-1).remove();
                    //同时移除localStorage中的缩略图
                    localStorage.removeItem("defectPhoto"+(imgId));console.log("defectPhoto"+(imgId))
                    inputArr.splice(imgIndex-1, 1); 
                    console.log(inputArr);
                    swipeUpModal.style.display="none";
                    //图片删完了显示描述文字
                    if($photoList.children().length==1){
                        $photoList.children().eq(0).removeClass("hide");
                    }
                    if($photoList.children().length<6){
                        $upLodaBtn.show();
                    } 
                }else if(showImgLi.contains(ev.target)) {
                    //查看大图
                    showImgModal.children[1].children[0].innerHTML='<img src="'+$photoList.children().eq(imgIndex).attr("src")+'" data-id="'+(imgId++)+'"/>';
                    showImg.show();
                }          
            });
            /*是否弹框*/
            //交通事故弹窗
            $("#accident").next().click(function(){
                //$(this).parent().next()是model  
                var _this=this;
                var $model=$(this).parent().next();
                new modal($model.get(0)).show();
                $model.find("label").one("touchstart",function(){
                    $model.find(".iconfont").removeClass("act");
                    $(this).children().addClass("act");
                    $(_this).prev().val($(this).attr("date-value"));
                    //$(this).prev().val()  返回1或者0 console.log($(this).prev().val())  
                    var trafficFlag=$(this).prev().val();
                    $("#trafficFlag").val(trafficFlag);
                    $model.hide();
                })
                return false;
            })
            //人员伤亡
            $("#hurt").next().click(function(){
                //$(this).parent().next()是model  
                var _this=this;
                var $model=$(this).parent().next();
                new modal($model.get(0)).show();
                $model.find("label").one("touchstart",function(){
                    $model.find(".iconfont").removeClass("act");
                    $(this).children().addClass("act");
                    $(_this).prev().val($(this).attr("date-value"));
                    //$(this).prev().val()  返回1或者0 console.log($(this).prev().val())
                    var hartFlag=$(this).prev().val();
                    $("#hartFlag").val(hartFlag);
                    $model.hide();
                })
                return false;
            })
            //保修期内
            $("#warranty").next().click(function(){
                var _this=this;
                var $model=$(this).parent().next();
                new modal($model.get(0)).show();
                $model.find("label").one("touchstart",function(){
                    $model.find(".iconfont").removeClass("act");
                    $(this).children().addClass("act");
                    $(_this).prev().val($(this).attr("date-value"));
                    //$(this).prev().val()  返回1或者0 console.log($(this).prev().val()) 
                    var warranty=$(this).prev().val();
                    $("#warrantys").val(warranty);
                    $model.hide();
                })
                return false;
            })

            /*表单提交验证*/
            var $mustInput=$(".mustInput");            
            oForm.onsubmit=function(){
                /*空值标记*/
                var flag=0;
                $mustInput.each(function(index,item){
                    if(this.value==""){
                        forbidBox.call(this.parentNode,"show");
                        remind({
                            obj:this,
                            text:"此项不能为空"
                        });
                        flag++;
                    }else{
                        forbidBox.call(this.parentNode,"no");
                    }                
                })
                /*有一个空则不能提交*/
                if(flag){
                    return false;
                }
                /*全部通过*/
                if(flag==0){
                   /* $mustInput.each(function(index,item){
                         setCookie(this.id,this.value||this.innerHTML,1);         
                    })*/  
                    /*存缩略图到localStorage中*/
                    $photoList.find("img").each(function(index,item){
                        localStorage.setItem("defectPhoto"+index,this.src);
                    }) 
                    location.href = "personInfo.html";               
                } 
                
            }
   
                          
        }(jQuery)
    </script>
</body>
</html>